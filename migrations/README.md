# Database Migrations

## Migration Strategy

This project uses **`drizzle-kit push`** for database schema synchronization:

- ✅ All schema changes are made in `shared/schema.ts`
- ✅ `drizzle-kit push` automatically syncs schema to database
- ✅ Production deployment runs migrations automatically (see `server/index.ts:82-127`)

## Current Migrations

### Active Migrations

**`0000_third_warpath.sql`** - Base schema (auto-generated by drizzle-kit)
- Contains full database schema
- Managed by drizzle-kit

**`add_gin_indexes.sql`** - Performance indexes
- GIN indexes for JSONB columns
- **Must be applied manually to production** (not handled by drizzle-kit)
- Run: `./scripts/apply-gin-indexes-production.sh`

### Archived Migrations (Obsolete)

Files in `archive/` folder are no longer needed:
- Their schema changes are already in `shared/schema.ts`
- Kept for historical reference only

## Making Schema Changes

### For Regular Schema Changes (columns, tables, constraints):

1. Edit `shared/schema.ts`
2. Local: Run `npm run db:push`
3. Production: Auto-applied on deployment via `server/index.ts`

### For Custom SQL (indexes, functions, triggers):

1. Create SQL file in `migrations/`
2. Apply manually to production:
   ```bash
   cat migrations/your-file.sql | flyctl postgres connect -a bidhive
   ```

## Production Database

**Fly.io PostgreSQL:**
- App: `bidhive`
- Connection: `postgresql://fly-user:***@pgbouncer.1zqyxr78xge0wp8m.flympg.net/fly-db`
- Schema syncs automatically on deployment
- Custom SQL must be applied manually

## Verification

Check production schema is up to date:
```bash
flyctl postgres connect -a bidhive
# Then in psql:
\dt               # List tables
\d portals        # Show portals table schema
\di+ idx_*        # Show indexes
```
