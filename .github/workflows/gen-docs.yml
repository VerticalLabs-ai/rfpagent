name: Auto-Generate Documentation

on:
    push:
        branches: [main]
        paths:
            - "src/**"
            - "lib/**"
    workflow_dispatch:
        inputs:
            scope:
                description: "Documentation scope"
                required: false
                default: "full"
                type: choice
                options:
                    - full
                    - api
                    - guides
                    - examples

jobs:
    generate-docs:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Install Tools
              run: |
                  npm install -g claude-flow@alpha
                  npm install -g jsdoc typedoc

            - name: Generate Documentation
              run: |
                  SCOPE="${{ github.event.inputs.scope || 'full' }}"

                  # Create docs directory
                  mkdir -p docs/generated

                  # Generate documentation index based on existing docs
                  node -e "
                    const fs = require('fs');
                    const path = require('path');

                    // Create index
                    let index = '# Generated Documentation\\n\\n';
                    index += 'Generated on: ' + new Date().toISOString() + '\\n\\n';
                    index += '## Scope: ' + process.env.SCOPE + '\\n\\n';
                    index += '## Available Documentation\\n\\n';

                    // Find existing documentation
                    if (fs.existsSync('docs')) {
                      const categories = {
                        'Technical': 'docs/technical',
                        'Testing': 'docs/testing',
                        'Deployment': 'docs/deployment',
                        'Guides': 'docs/guides',
                        'API': 'docs/api'
                      };

                      Object.entries(categories).forEach(([name, dir]) => {
                        if (fs.existsSync(dir)) {
                          index += '### ' + name + '\\n\\n';
                          const files = fs.readdirSync(dir).filter(f => f.endsWith('.md'));
                          files.forEach(file => {
                            const title = file.replace('.md', '').replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());
                            index += '- [' + title + '](../' + path.relative('docs/generated', path.join(dir, file)) + ')\\n';
                          });
                          index += '\\n';
                        }
                      });
                    }

                    index += '## Root Documentation\\n\\n';
                    ['README.md', 'CLAUDE.md', 'TESTING_BASELINE.md', 'MODELS_REFERENCE.md'].forEach(file => {
                      if (fs.existsSync(file)) {
                        const title = file.replace('.md', '').replace(/_/g, ' ');
                        index += '- [' + title + '](../../' + file + ')\\n';
                      }
                    });

                    fs.writeFileSync('docs/generated/index.md', index);
                    console.log('Documentation index generated successfully');
                  "
              env:
                  SCOPE: ${{ github.event.inputs.scope || 'full' }}

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./docs/generated
                  destination_dir: api-docs
