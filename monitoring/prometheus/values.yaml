# Prometheus configuration for RFP Agent monitoring
# Install with: helm install prometheus prometheus-community/prometheus -f monitoring/prometheus/values.yaml

alertmanager:
  enabled: true
  ingress:
    enabled: true
    hosts:
      - alertmanager.rfpagent.app

server:
  ingress:
    enabled: true
    hosts:
      - prometheus.rfpagent.app

  retention: "15d"

  global:
    scrape_interval: 15s
    evaluation_interval: 15s
    external_labels:
      cluster: 'rfp-agent-production'

  # Alert rules
  extraScrapeConfigs: |
    - job_name: 'rfp-agent'
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: rfp-agent
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          target_label: __address__

serverFiles:
  alerting_rules.yml:
    groups:
      - name: rfp-agent-alerts
        interval: 30s
        rules:
          # High error rate
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High error rate detected"
              description: "Error rate is {{ $value }} errors/sec"

          # High response time
          - alert: HighResponseTime
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High response time detected"
              description: "95th percentile response time is {{ $value }}s"

          # Pod crash loop
          - alert: PodCrashLooping
            expr: rate(kube_pod_container_status_restarts_total{pod=~"rfp-agent.*"}[15m]) > 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pod {{ $labels.pod }} is crash looping"
              description: "Pod has restarted {{ $value }} times in the last 15 minutes"

          # High memory usage
          - alert: HighMemoryUsage
            expr: container_memory_usage_bytes{pod=~"rfp-agent.*"} / container_spec_memory_limit_bytes{pod=~"rfp-agent.*"} > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on {{ $labels.pod }}"
              description: "Memory usage is {{ $value | humanizePercentage }}"

          # High CPU usage
          - alert: HighCPUUsage
            expr: rate(container_cpu_usage_seconds_total{pod=~"rfp-agent.*"}[5m]) > 0.9
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on {{ $labels.pod }}"
              description: "CPU usage is {{ $value | humanizePercentage }}"

          # Database connection pool exhaustion
          - alert: DatabaseConnectionPoolExhausted
            expr: db_connection_pool_active / db_connection_pool_size > 0.9
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Database connection pool near exhaustion"
              description: "Connection pool utilization is {{ $value | humanizePercentage }}"

pushgateway:
  enabled: false

nodeExporter:
  enabled: true

kubeStateMetrics:
  enabled: true
